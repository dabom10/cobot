<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‘ì‚° M0609 ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="web_ui.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>

  <div class="container">
    <div class="header">
      <h1>ë‘ì‚° M0609 ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
      <div class="header-status"><span class="dot"></span><span>Firebase ì—°ê²°ë¨</span></div>
    </div>

    <div id="error-container" class="error-container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong style="color:var(--danger)">âš ï¸ Robot Error</strong>
            <button onclick="clearError()" style="border:none; background:var(--danger); color:white; padding:4px 8px; border-radius:4px; cursor:pointer">Clear</button>
        </div>
        <div id="error-message" style="font-size:14px; color:#991b1b"></div>
    </div>

    <div class="dashboard">
      <div class="card">
        <div class="card-header">
          <span class="card-title">ë¡œë´‡ ë©”ì¸ ìƒíƒœ</span>
          <div class="card-icon blue">ğŸ¤–</div>
        </div>
        <div id="robot-state-status" class="status-badge standby">STANDBY</div>
        <div class="process-info">
          <div class="process-item">
            <div class="process-label">ê³µì • ìƒíƒœ</div>
            <div class="process-value" id="dsr-status-value">ê°€ë™ ì¤€ë¹„ ì™„ë£Œ</div>
          </div>
          <div class="process-item">
            <div class="process-label">ê³µì • ì§„ì²™ë„</div>
            <div class="process-value" id="dsr-process-value">0%</div>
          </div>
        </div>
        <div class="process-info" style="margin-top: 12px;">
          <div class="process-item" style="flex: 2;">
            <div class="process-label">ë¡œë´‡ ëª¨ë“œ</div>
            <div class="process-value" id="robot-mode-value" style="font-size: 13px;">-</div>
          </div>
          <div class="process-item" style="flex: 3; display: flex; gap: 6px; align-items: center; justify-content: center;">
            <button id="btn-mode-manual" onclick="setRobotMode(0)" style="padding: 6px 12px; font-size: 11px; border: none; border-radius: 6px; cursor: pointer; background: #3b82f6; color: white; font-weight: 600;">Manual</button>
            <button id="btn-mode-auto" onclick="setRobotMode(1)" style="padding: 6px 12px; font-size: 11px; border: none; border-radius: 6px; cursor: pointer; background: #10b981; color: white; font-weight: 600;">Auto</button>
            <span id="set-mode-status" style="font-size: 10px; color: #9ca3af; min-width: 40px;">ëŒ€ê¸°</span>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ê´€ì ˆ ê°ë„</span>
          <div class="card-icon green">âš™ï¸</div>
        </div>
        <div class="data-grid">
          <div class="data-row"><span class="data-label">J1</span><div><span class="data-value" id="joint_1">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">J2</span><div><span class="data-value" id="joint_2">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">J3</span><div><span class="data-value" id="joint_3">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">J4</span><div><span class="data-value" id="joint_4">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">J5</span><div><span class="data-value" id="joint_5">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">J6</span><div><span class="data-value" id="joint_6">-</span><span class="data-unit">Â°</span></div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">TCP ìœ„ì¹˜</span>
          <div class="card-icon purple">ğŸ“</div>
          
        </div>
        <div class="data-grid">
          <div class="data-row"><span class="data-label">X</span><div><span class="data-value" id="tcp_x">-</span><span class="data-unit">mm</span></div></div>
          <div class="data-row"><span class="data-label">Y</span><div><span class="data-value" id="tcp_y">-</span><span class="data-unit">mm</span></div></div>
          <div class="data-row"><span class="data-label">Z</span><div><span class="data-value" id="tcp_z">-</span><span class="data-unit">mm</span></div></div>
          <div class="data-row"><span class="data-label">RX</span><div><span class="data-value" id="tcp_rx">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">RY</span><div><span class="data-value" id="tcp_ry">-</span><span class="data-unit">Â°</span></div></div>
          <div class="data-row"><span class="data-label">RZ</span><div><span class="data-value" id="tcp_rz">-</span><span class="data-unit">Â°</span></div></div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">ì œì–´ íŒ¨ë„</span>
          <div class="card-icon orange">ğŸ”§</div>
        </div>
        <div class="tool-current">
          <div style="font-size:11px; color:var(--gray-500)">Active Tool</div>
          <div id="current-tool-name" style="font-size:18px; font-weight:700; color:var(--primary-dark)">-</div>
        </div>
        <div class="control-grid">
          <div class="control-item">
            <button id="btn-start-process" class="btn" style="background: #059669;" onclick="executeStartProcess()">ê³µì •ì‹œì‘</button>
            <span id="start-process-status" class="status-text">ëŒ€ê¸°</span>
          </div>
          <div class="control-item">
            <button id="btn-move-home-1" class="btn btn-success" onclick="executeMoveHome(1)">Home</button>
            <span id="move-home-status" class="status-text">ëŒ€ê¸°</span>
          </div>
          <div class="control-item">
            <button id="btn-move-circle" class="btn btn-purple" onclick="executeMoveCircle()">Circle</button>
            <span id="move-circle-status" class="status-text">ëŒ€ê¸°</span>
          </div>
          <div class="control-item">
            <button id="btn-move-line" class="btn btn-orange" onclick="executeMoveLine()">Line</button>
            <span id="move-line-status" class="status-text">ëŒ€ê¸°</span>
          </div>
          <div class="control-item">
            <button id="btn-user-cmd" class="btn" style="background: var(--danger);" onclick="executeUserCmd(0)">Pause</button>
            <!-- <button id="btn-stop-user-cmd" class="btn" style="background: var(--gray-600); flex: 0 0 auto; padding: 12px 10px; font-size: 12px;" onclick="stopUserCmd(0)">ë³µêµ¬ëª¨ë“œì¤‘ì§€</button> -->
            <span id="user-cmd-status" class="status-text">ëŒ€ê¸°</span>
          </div>
          <div class="control-item">
            <button id="btn-user-cmd-2" class="btn" style="background: #8b5cf6;" onclick="executeUserCmd(1)">Continue</button>
            <!-- <button id="btn-stop-user-cmd-2" class="btn" style="background: var(--gray-600); flex: 0 0 auto; padding: 12px 10px; font-size: 12px;" onclick="stopUserCmd(1)">ì¬ê°œì¤‘ì§€</button> -->
            <span id="user-cmd-status-2" class="status-text">ëŒ€ê¸°</span>
          </div>
          <!-- <div class="control-item">
            <button id="btn-servo-off" class="btn" style="background: var(--danger);" onclick="executeServoOff()">Servo Off</button>
            <span id="servo-off-status" class="status-text">ëŒ€ê¸°</span> -->
          </div>
        </div>
      </div>
    </div>

    <div class="footer">Doosan M0609 Robot Monitoring System</div>
  </div>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBoWy1kWi5lwMnRVs2MeOS96udqWhe-MJU",
      authDomain: "rokey-1f8f3.firebaseapp.com",
      databaseURL: "https://rokey-1f8f3-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "rokey-1f8f3",
      storageBucket: "rokey-1f8f3.firebasestorage.app",
      messagingSenderId: "405786322615",
      appId: "1:405786322615:web:b75b9bcd4207a4eda60f32"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ì¡°ì¸íŠ¸ ìƒíƒœ êµ¬ë…
    database.ref('robot_status/joint_states/joints').on('value', (snapshot) => {
      const joints = snapshot.val();
      if (joints) {
        for (let i = 1; i <= 6; i++) {
          const el = document.getElementById('joint_' + i);
          if (joints['joint_' + i] && el) {
            el.innerText = joints['joint_' + i].position_deg?.toFixed(2) || '-';
          }
        }
      }
    });

    // Robot State êµ¬ë…
    database.ref('robot_status/robot_state').on('value', (snapshot) => {
      const data = snapshot.val();
      const stateBox = document.getElementById('robot-state-status');
      if (data && stateBox) {
        stateBox.innerText = data.state_name || '-';
        stateBox.className = 'status-badge';
        if (data.state_name === 'MOVING') stateBox.classList.add('moving');
        else if (data.state_name === 'EMERGENCY_STOP' || data.state_name === 'SAFE_STOP') stateBox.classList.add('emergency');
      }
    });

    // TCP ìœ„ì¹˜ êµ¬ë…
    database.ref('robot_status/tcp').on('value', (snapshot) => {
      const tcp = snapshot.val();
      if (tcp) {
        ['x', 'y', 'z', 'rx', 'ry', 'rz'].forEach(f => {
          const el = document.getElementById('tcp_' + f);
          if (el && tcp[f] !== undefined) el.innerText = tcp[f].toFixed(2);
        });
      }
    });

    // DSR Status/Process êµ¬ë…
    database.ref('robot_status/dsr_status').on('value', (snapshot) => {
      const data = snapshot.val();
      const el = document.getElementById('dsr-status-value');
      if (data && el) el.innerText = data.value || 'system-ready';
    });

    database.ref('robot_status/dsr_process').on('value', (snapshot) => {
      const data = snapshot.val();
      const el = document.getElementById('dsr-process-value');
      if (data && el) el.innerText = (data.value !== undefined ? data.value + '%' : '0%');
    });

    // Robot Mode êµ¬ë…
    database.ref('robot_status/robot_mode').on('value', (snapshot) => {
      const data = snapshot.val();
      const el = document.getElementById('robot-mode-value');
      if (data && el) el.innerText = data.robot_mode || '-';
    });

    // Set Robot Mode
    const setRobotModeRef = database.ref('robot_command/set_robot_mode');
    setRobotModeRef.on('value', (snapshot) => {
      const data = snapshot.val();
      const statusEl = document.getElementById('set-mode-status');
      if (data?.status && statusEl) {
        if (data.status === 'success') {
          statusEl.style.color = '#10b981';
          statusEl.innerText = 'OK';
        } else if (data.status === 'failed' || data.status.startsWith?.('error')) {
          statusEl.style.color = '#ef4444';
          statusEl.innerText = 'Fail';
        } else {
          statusEl.style.color = '#3b82f6';
          statusEl.innerText = '...';
        }
      }
    });

    function setRobotMode(mode) {
      const modeNames = {0: 'Manual', 1: 'Auto', 2: 'Measure'};
      if (!confirm(`ë¡œë´‡ ëª¨ë“œë¥¼ ${modeNames[mode]}ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

      document.getElementById('btn-mode-manual').disabled = true;
      document.getElementById('btn-mode-auto').disabled = true;
      document.getElementById('set-mode-status').innerText = '...';
      document.getElementById('set-mode-status').style.color = '#3b82f6';

      setRobotModeRef.update({ execute: true, status: 'pending', mode: mode })
        .finally(() => {
          setTimeout(() => {
            document.getElementById('btn-mode-manual').disabled = false;
            document.getElementById('btn-mode-auto').disabled = false;
          }, 1000);
        });
    }

    // Current Tool êµ¬ë…
    database.ref('robot_status/current_tool').on('value', (snapshot) => {
      const data = snapshot.val();
      const el = document.getElementById('current-tool-name');
      if (data && el) el.innerText = data.name || '-';
    });

    // Error êµ¬ë…
    const errorRef = database.ref('robot_status/error');
    errorRef.on('value', (snapshot) => {
      const data = snapshot.val();
      const container = document.getElementById('error-container');
      const msg = document.getElementById('error-message');
      if (data && container && msg) {
        if (data.has_error && data.message) {
          container.style.display = 'block';
          msg.innerText = data.message;
        } else {
          container.style.display = 'none';
        }
      }
    });

    function clearError() {
      errorRef.update({ message: '', has_error: false, last_update: Date.now() / 1000 });
    }

    // Move Home
    const moveHomeRef = database.ref('robot_command/move_home');
    moveHomeRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data?.status) updateStatus('move-home-status', data.status);
    });

    function executeMoveHome(target) {
      document.getElementById('btn-move-home-1').disabled = true;
      updateStatus('move-home-status', 'pending');
      moveHomeRef.update({ execute: true, status: 'pending', target: target })
        .finally(() => setTimeout(() => document.getElementById('btn-move-home-1').disabled = false, 1000));
    }

    // Move Circle
    const moveCircleRef = database.ref('robot_command/move_circle');
    moveCircleRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data?.status) updateStatus('move-circle-status', data.status);
    });

    function executeMoveCircle() {
      document.getElementById('btn-move-circle').disabled = true;
      updateStatus('move-circle-status', 'pending');
      moveCircleRef.update({ execute: true, status: 'pending' })
        .finally(() => setTimeout(() => document.getElementById('btn-move-circle').disabled = false, 1000));
    }

    // Move Line
    const moveLineRef = database.ref('robot_command/move_line');
    moveLineRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data?.status) updateStatus('move-line-status', data.status);
    });

    function executeMoveLine() {
      document.getElementById('btn-move-line').disabled = true;
      updateStatus('move-line-status', 'pending');
      moveLineRef.update({ execute: true, status: 'pending' })
        .finally(() => setTimeout(() => document.getElementById('btn-move-line').disabled = false, 1000));
    }

    // Start Process (ê³µì •ì‹œì‘)
    const startProcessRef = database.ref('robot_command/start_process');
    startProcessRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data?.status) updateStatus('start-process-status', data.status);
    });

    function executeStartProcess() {
      document.getElementById('btn-start-process').disabled = true;
      updateStatus('start-process-status', 'pending');
      startProcessRef.update({ execute: true, status: 'pending' })
        .finally(() => setTimeout(() => document.getElementById('btn-start-process').disabled = false, 1000));
    }

    // Recovery Mode
    const recoveryModeRef = database.ref('robot_command/user_cmd');

    recoveryModeRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data?.status) {
        updateStatus('user-cmd-status', data.status);
        updateStatus('user-cmd-status-2', data.status);
      }
    });

    function executeUserCmd(action = 0) {
      const isRecovery = action === 0;
      const btnId = isRecovery ? 'btn-user-cmd' : 'btn-user-cmd-2';
      const statusId = isRecovery ? 'user-cmd-status' : 'user-cmd-status-2';
      const label = isRecovery ? 'Recovery Mode' : 'Continue';
      const emoji = isRecovery ? 'ğŸ”µ' : 'ğŸŸ£';

      console.log(`${emoji} ${label} ë²„íŠ¼ í´ë¦­!`);

      const btnElement = document.getElementById(btnId);
      if (!btnElement) {
        console.error('âŒ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        return;
      }

      btnElement.disabled = true;
      updateStatus(statusId, 'pending');
      const updateData = { execute: true, action: action, status: 'pending' };
      console.log(`${emoji} Firebase ì—…ë°ì´íŠ¸ ì‹œë„:`, updateData);
      recoveryModeRef.update(updateData)
        .then(() => {
          console.log('âœ… Firebase ì—…ë°ì´íŠ¸ ì„±ê³µ!');
          return recoveryModeRef.get();
        })
        .then((snapshot) => {
          console.log('âœ… Firebaseì— ì €ì¥ëœ ê°’:', snapshot.val());
        })
        .catch((error) => {
          console.error('âŒ Firebase ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
          console.error('âŒ ì—ëŸ¬ ìƒì„¸:', error.code, error.message);
        })
        .finally(() => {
          setTimeout(() => {
            btnElement.disabled = false;
            console.log(`${emoji} ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”`);
          }, 1000);
        });
    }

    function stopUserCmd(stopAction) {
      console.log(`ğŸ›‘ Recovery Mode ì¤‘ì§€ ë²„íŠ¼ í´ë¦­! (action: ${stopAction})`);
      const btnId = stopAction === 0 ? 'btn-stop-user-cmd' : 'btn-stop-user-cmd-2';
      const statusId = stopAction === 0 ? 'user-cmd-status' : 'user-cmd-status-2';
      const btnElement = document.getElementById(btnId);
      if (btnElement) {
        btnElement.disabled = true;
      }
      updateStatus(statusId, 'ì¤‘ì§€ì¤‘...');
      recoveryModeRef.update({
        stop: true,
        stop_action: stopAction,
        status: 'stop_requested'
      })
        .then(() => {
          console.log(`âœ… ì¤‘ì§€ ëª…ë ¹ ì „ì†¡ ì™„ë£Œ (action: ${stopAction})`);
        })
        .catch((error) => {
          console.error('âŒ ì¤‘ì§€ ëª…ë ¹ ì‹¤íŒ¨:', error);
        })
        .finally(() => {
          setTimeout(() => {
            if (btnElement) {
              btnElement.disabled = false;
            }
          }, 1000);
        });
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸ í—¬í¼
    function updateStatus(id, status) {
      const el = document.getElementById(id);
      if (!el) return;
      el.className = 'status-text';
      if (status === 'success') { el.style.color = 'var(--success)'; el.innerText = 'Success'; }
      else if (status === 'failed' || status.startsWith?.('error')) { el.style.color = 'var(--danger)'; el.innerText = 'Failed'; }
      else if (status === 'pending') { el.style.color = 'var(--primary)'; el.innerText = 'ì‹¤í–‰ì¤‘...'; }
      else { el.style.color = 'var(--gray-400)'; el.innerText = status || 'ëŒ€ê¸°'; }
    }
  </script>
</body>
</html>